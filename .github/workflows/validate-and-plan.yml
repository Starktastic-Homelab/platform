name: Validate and plan Kubernetes manifests

on:
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: '3.x'
          pip-install: 'yamllint'

      - name: YAML Lint
        id: yamllint
        run: |
          set +e
          yamllint . > yamllint.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -ne 0 ]; then echo "âŒ YAML Lint Failed"; else echo "âœ… YAML Lint Passed"; fi
        env:
          YAMLLINT_CONFIG_FILE: .github/yamllint.yaml

      - name: Setup Kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          echo "$PWD" >> $GITHUB_PATH

      - name: Validate static manifests
        id: kubeconform
        run: |
          set +e
          find . -type f -name '*.yaml' -path '*/manifests/*' -print0 | xargs -0 kubeconform \
            -verbose -summary -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' > kubeconform.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          if [ $EXIT_CODE -ne 0 ]; then echo "âŒ Kubeconform Failed"; else echo "âœ… Kubeconform Passed"; fi

      - name: Create validation report
        if: always()
        run: |
          echo "### ðŸ›¡ï¸ Static Validation" > validation-report.md

          if [ "${{ steps.yamllint.outputs.exit_code }}" -eq 0 ]; then
            echo "âœ… **YAML Lint:** Passed" >> validation-report.md
          else
            echo "âŒ **YAML Lint:** FAILED" >> validation-report.md
            echo "<details><summary>Log</summary><pre>" >> validation-report.md
            cat yamllint.txt >> validation-report.md
            echo "</pre></details>" >> validation-report.md
          fi

          if [ "${{ steps.kubeconform.outputs.exit_code }}" -eq 0 ]; then
             echo "âœ… **Kubeconform:** Passed" >> validation-report.md
             echo "<details><summary>Summary</summary><pre>" >> validation-report.md
             tail -n 5 kubeconform.txt >> validation-report.md
             echo "</pre></details>" >> validation-report.md
          else
             echo "âŒ **Kubeconform:** FAILED" >> validation-report.md
             echo "<details><summary>Log</summary><pre>" >> validation-report.md
             cat kubeconform.txt >> validation-report.md
             echo "</pre></details>" >> validation-report.md
          fi

          echo "" >> validation-report.md

      - name: Upload validation report artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: validation-report
          path: validation-report.md
          retention-days: 1

      - name: Check status
        if: steps.yamllint.outputs.exit_code != 0 || steps.kubeconform.outputs.exit_code != 0
        run: exit 1

  plan:
    name: Live cluster diff
    needs: validate
    runs-on: self-hosted
    container:
      image: buildpack-deps:scm
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Required to compare against main

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_RAW }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Setup Kubectl
        uses: azure/setup-kubectl@v4.0.1
        with:
          version: 'latest'

      - name: Setup ArgoCD CLI
        uses: clowdhaus/argo-cd-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: version
          options: --client

      - name: Setup YQ
        run: |
          curl -sSLo /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Setup Dyff
        run: |
          curl -sL https://github.com/homeport/dyff/releases/download/v1.10.3/dyff_1.10.3_linux_amd64.tar.gz | tar xz
          mv dyff /usr/local/bin/
          chmod +x /usr/local/bin/dyff

      - name: Generate raw diff
        run: |
          echo "### ðŸ“„ Raw File Changes" > plan.md

          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git fetch origin ${{ github.base_ref }}

          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- apps/ | grep -E '\.(yaml|yml)$' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No raw manifest changes detected." >> plan.md
          else
            echo "<details><summary>Click to expand</summary>" >> plan.md
            echo "" >> plan.md

            for file in $CHANGED_FILES; do
              echo "#### Changes in \`$file\`" >> plan.md
              echo "\`\`\`text" >> plan.md

              if git show "origin/${{ github.base_ref }}:$file" > old_version.yaml 2>/dev/null; then
                 dyff between --color=off old_version.yaml "$file" >> plan.md
              else
                 echo "New file created." >> plan.md
              fi

              echo "\`\`\`" >> plan.md
            done

            echo "</details>" >> plan.md
          fi
          echo "" >> plan.md

      - name: Generate full manifests with PR SHA
        env:
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          kubectl config set-context --current --namespace=argocd
          touch all_manifests.yaml

          REPO_URL="${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}.git"

          echo "Processing AppSets..."
          for appset in apps/bootstrap/appsets/*.yaml; do
            echo "Generating from: $appset"
            yq -i ".spec.generators[0].git.revision = \"$PR_SHA\"" $appset
            yq -i ".spec.template.spec.sources[] |= select(.repoURL == \"$REPO_URL\").targetRevision = \"$PR_SHA\"" $appset
            argocd appset generate --core --loglevel error -o yaml $appset | yq -P '.[]' | sed 's/^apiVersion:/---\napiVersion:/' >> all_manifests.yaml
          done

          echo "Processing standalone Apps..."
          for app in apps/bootstrap/*.yaml; do
            echo "Processing App: $app"
            yq -i ".spec.source.targetRevision = \"$PR_SHA\"" $app
            echo "---" >> all_manifests.yaml
            cat $app >> all_manifests.yaml
          done

      - name: Run dyff
        run: |
          echo "### ðŸ”® Kubernetes Live Plan" >> plan.md

          chmod +x scripts/dyff-wrapper.sh
          export KUBECTL_EXTERNAL_DIFF="$PWD/scripts/dyff-wrapper.sh"

          set +e
          DIFF_OUTPUT=$(kubectl diff -f all_manifests.yaml --server-side --force-conflicts 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 1 ]; then
            echo "âš ï¸ **Changes detected**" >> plan.md
            echo "<details><summary><strong>Show Plan</strong></summary>" >> plan.md
            echo "" >> plan.md
            echo "\`\`\`yaml" >> plan.md
            echo "$DIFF_OUTPUT" >> plan.md
            echo "\`\`\`" >> plan.md
            echo "</details>" >> plan.md
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "âœ… **No ArgoCD App changes detected**" >> plan.md
          else
            echo "âŒ **Diff Failed** (Exit Code: $EXIT_CODE)" >> plan.md
            echo "\`\`\`" >> plan.md
            echo "$DIFF_OUTPUT" >> plan.md
            echo "\`\`\`" >> plan.md
            exit 1
          fi

      - name: Upload plan artifact
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: plan-report
          path: plan.md
          retention-days: 1

  report:
    name: Report status
    needs: [validate, plan]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts
          merge-multiple: true

      - name: Assemble comment
        run: |
          touch comment.md

          if [ -f artifacts/validation-report.md ]; then
            cat artifacts/validation-report.md >> comment.md
            echo "" >> comment.md
            echo "---" >> comment.md
            echo "" >> comment.md
          fi

          if [ -f artifacts/plan.md ]; then
            cat artifacts/plan.md >> comment.md
          fi

      - name: Post comment
        uses: marocchino/sticky-pull-request-comment@v2.9.4
        with:
          header: ci-report
          path: comment.md
