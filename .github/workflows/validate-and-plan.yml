name: CI

on:
  pull_request:
    branches: [main]

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: Cloud Runner (Validation & Generation)
  # ------------------------------------------------------------------
  validate:
    name: ‚ö° Generate & Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: '3.x'
          pip-install: 'yamllint'

      - name: Setup Kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          echo "$PWD" >> $GITHUB_PATH

      - name: Setup ArgoCD CLI
        uses: clowdhaus/argo-cd-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          version: v3.2.0
          command: version
          options: --client

      - name: YAML Lint
        run: yamllint .
        env:
          YAMLLINT_CONFIG_FILE: .github/yamllint.yaml

      - name: Validate static manifests
        run: find . -type f -name '*.yaml' -path '*/manifests/*' -print0 | xargs -0 kubeconform -verbose -ignore-missing-schemas -summary

      - name: Generate Full Manifests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          touch all_manifests.yaml

          echo "Processing AppSets..."
          for appset in apps/bootstrap/appsets/*.yaml; do
            echo "Generating from: $appset"
            yq -i ".spec.generators[0].git.revision = \"$PR_SHA\"" $appset
            echo "---" >> all_manifests.yaml
            argocd appset generate $appset >> all_manifests.yaml
          done

          echo "Processing standalone Apps..."
          for app in apps/bootstrap/*.yaml; do
            echo "Processing App: $app"
            yq -i ".spec.source.targetRevision = \"$PR_SHA\"" $app
            echo "---" >> all_manifests.yaml
            cat $app >> all_manifests.yaml
          done

          echo "Validating..."
          cat all_manifests.yaml | kubeconform -verbose -ignore-missing-schemas -summary

      - name: Upload Manifests
        uses: actions/upload-artifact@v4
        with:
          name: proposed-manifests
          path: all_manifests.yaml
          retention-days: 1

  # ------------------------------------------------------------------
  # STAGE 2: Self-Hosted Runner (Live Plan)
  # ------------------------------------------------------------------
  live-plan:
    name: üîÆ Live Cluster Diff
    needs: validate
    runs-on: self-hosted
    container:
      image: bitnami/kubectl:latest
    steps:
      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_RAW }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Download Manifests
        uses: actions/download-artifact@v4
        with:
          name: proposed-manifests

      - name: Run Diff
        id: diff
        run: |
          echo "### üîÆ Kubernetes Live Plan" > plan.md
          
          set +e
          DIFF_OUTPUT=$(kubectl diff -f all_manifests.yaml --server-side 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 1 ]; then
            echo "‚ö†Ô∏è **Changes Detected**"
            echo "<details><summary><strong>Show Plan</strong></summary>" >> plan.md
            echo "" >> plan.md
            echo "\`\`\`diff" >> plan.md
            echo "$DIFF_OUTPUT" | head -c 60000 >> plan.md
            echo "\`\`\`" >> plan.md
            echo "</details>" >> plan.md
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ No changes detected against live cluster." >> plan.md
          else
            echo "‚ùå **Diff Failed** (Exit Code: $EXIT_CODE)" >> plan.md
            echo "\`\`\`" >> plan.md
            echo "$DIFF_OUTPUT" >> plan.md
            echo "\`\`\`" >> plan.md
          fi
          
          cat plan.md
