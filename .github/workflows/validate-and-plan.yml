name: CI

on:
  pull_request:
    branches: [main]

jobs:
  # ------------------------------------------------------------------
  # STAGE 1: Cloud Runner (Validation)
  # ------------------------------------------------------------------
  validate:
    name: Validate & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v6.1.0
        with:
          python-version: '3.x'
          pip-install: 'yamllint'

      - name: Setup Kubeconform
        run: |
          curl -L https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz | tar xz
          echo "$PWD" >> $GITHUB_PATH

      - name: YAML Lint
        run: yamllint .
        env:
          YAMLLINT_CONFIG_FILE: .github/yamllint.yaml

      - name: Validate static manifests
        run: |
          find . -type f -name '*.yaml' -path '*/manifests/*' -print0 | xargs -0 kubeconform \
            -verbose \
            -summary \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json'

  # ------------------------------------------------------------------
  # STAGE 2: Self-Hosted Runner (Generation & Plan)
  # ------------------------------------------------------------------
  live-plan:
    name: Live Cluster Diff
    needs: validate
    runs-on: self-hosted
    container:
      image: buildpack-deps:scm
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_RAW }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Setup Kubectl
        uses: azure/setup-kubectl@v4.0.1
        with:
          version: 'latest'

      - name: Setup ArgoCD CLI
        uses: clowdhaus/argo-cd-action@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          version: 3.2.6
          command: version
          options: --client

      - name: Setup YQ
        run: |
          curl -sSLo /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Generate Full Manifests
        env:
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          kubectl config set-context --current --namespace=argocd
          touch all_manifests.yaml

          echo "Processing AppSets..."
          for appset in apps/bootstrap/appsets/*.yaml; do
            echo "Generating from: $appset"
            # Time Travel Patching
            yq -i ".spec.generators[0].git.revision = \"$PR_SHA\"" $appset
            echo "---" >> all_manifests.yaml
            argocd appset generate --core --loglevel error -o yaml $appset >> all_manifests.yaml
          done

          echo "Processing standalone Apps..."
          for app in apps/bootstrap/*.yaml; do
            echo "Processing App: $app"
            yq -i ".spec.source.targetRevision = \"$PR_SHA\"" $app
            echo "---" >> all_manifests.yaml
            cat $app >> all_manifests.yaml
          done

      - name: "[DEBUG] Inspect Generated Manifests"
        run: |
          echo "================ ALL MANIFESTS YAML ================"
          cat all_manifests.yaml
          echo "===================================================="

      - name: Run Diff
        id: diff
        run: |
          echo "### üîÆ Kubernetes Live Plan" > plan.md

          set +e
          # Diff generated manifests against the live cluster
          DIFF_OUTPUT=$(kubectl diff -f all_manifests.yaml --server-side 2>&1)
          EXIT_CODE=$?
          set -e

          if [ $EXIT_CODE -eq 1 ]; then
            echo "‚ö†Ô∏è **Changes Detected**"
            echo "<details><summary><strong>Show Plan</strong></summary>" >> plan.md
            echo "" >> plan.md
            echo "\`\`\`diff" >> plan.md
            echo "$DIFF_OUTPUT" | head -c 60000 >> plan.md
            echo "\`\`\`" >> plan.md
            echo "</details>" >> plan.md
          elif [ $EXIT_CODE -eq 0 ]; then
            echo "‚úÖ No changes detected against live cluster." >> plan.md
          else
            echo "‚ùå **Diff Failed** (Exit Code: $EXIT_CODE)" >> plan.md
            echo "\`\`\`" >> plan.md
            echo "$DIFF_OUTPUT" >> plan.md
            echo "\`\`\`" >> plan.md
          fi

          cat plan.md
